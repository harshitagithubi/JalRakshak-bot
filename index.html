<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JalRakshak - Emergency Chat Assistant</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: linear-gradient(135deg, #006064 0%, #00838f 100%);
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .main-content {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        /* 1. PRIORITY: Accessibility Controls */
        .accessibility-section {
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            flex-wrap: wrap;
            gap: 10px;
            border: 2px solid #006064;
        }

        #lang-select {
            padding: 8px 12px;
            border-radius: 15px;
            border: 2px solid #006064;
            background: white;
            color: #006064;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
        }

        #clear-chat-btn {
            padding: 8px 15px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        #clear-chat-btn:hover {
            background: #d32f2f;
            transform: translateY(-1px);
        }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 15px;
      gap: 15px;
      max-height: calc(100vh - 140px);
    }

    /* Desktop Layout - Chat and Map Side by Side (SWAPPED ORDER) */
    .desktop-layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      margin-bottom: 15px;
    }

    .map-section {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border: 2px solid rgba(0,96,100,0.2);
      height: fit-content;
      order: 2; /* Map moves to right side */
    }

    .controls-panel {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .map-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
      font-weight: 600;
      color: #006064;
      font-size: 1.1rem;
    }

    #small-map {
      height: 300px;
      width: 100%;
      border-radius: 10px;
      border: 2px solid #e0e0e0;
      margin-bottom: 15px;
    }

    .location-display {
      padding: 15px;
      background: #f0f9ff;
      border-radius: 12px;
      border-left: 4px solid #006064;
    }

    .location-text {
      font-size: 1rem;
      color: #333;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .coordinates-text {
      font-size: 0.9rem;
      color: #006064;
      font-family: 'Courier New', monospace;
      background: rgba(0,96,100,0.1);
      padding: 8px 12px;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .address-text {
      font-size: 0.95rem;
      color: #444;
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .location-timestamp {
      font-size: 0.85rem;
      color: #666;
      font-style: italic;
    }

    /* Disaster Options */
    #disaster-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      padding: 20px;
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border: 2px solid #4caf50; /* Green border to make it more visible */
    }

    .option-btn {
      padding: 12px 16px;
      border: none;
      border-radius: 25px;
      background: #00796b;
      color: white;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      text-align: center;
    }

    .option-btn:hover {
      background: #004d40;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,77,64,0.3);
    }

    /* Photo Upload Grid - Bigger Buttons */
    .photo-section {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .photo-title {
      font-weight: 600;
      color: #006064;
      margin-bottom: 15px;
      text-align: center;
      font-size: 1.1rem;
    }

    #photo-upload {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 15px;
    }

    .photo-slot {
      width: 80px;
      height: 80px;
      border: 3px dashed #00acc1;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: #e0f7fa;
      transition: all 0.3s ease;
      font-size: 24px;
      font-weight: bold;
    }

    .photo-slot:hover {
      border-color: #006064;
      background: #b2ebf2;
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,96,100,0.2);
    }

    .photo-slot input {
      display: none;
    }

    .photo-slot.filled {
      background: #4caf50;
      color: white;
      border-color: #4caf50;
      border-style: solid;
      font-size: 28px;
    }

    /* Emergency Button */
    #emergency-btn {
      padding: 18px 25px;
      background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
      color: white;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      font-size: 1.2rem;
      font-weight: 700;
      box-shadow: 0 6px 20px rgba(211,47,47,0.4);
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    #emergency-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(211,47,47,0.6);
    }

    /* Chat Section */
    .chat-container {
      flex: 1;
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 300px;
      order: 1; /* Chat moves to left side */
    }

    #messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: #fafafa;
    }

    #messages::-webkit-scrollbar {
      width: 8px;
    }

    #messages::-webkit-scrollbar-thumb {
      background: #09b1c7;
      border-radius: 4px;
    }

    .message {
      max-width: 75%;
      padding: 15px 18px;
      border-radius: 18px;
      word-wrap: break-word;
      animation: slideIn 0.3s ease-out;
    }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.bot {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .message.user {
            background: #80deea;
            color: #333;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .message.emergency-location {
            background: linear-gradient(135deg, #ff5722 0%, #d84315 100%) !important;
            color: white !important;
            border: 2px solid #bf360c !important;
            animation: pulse 1s infinite alternate;
        }

    @keyframes pulse {
      from { box-shadow: 0 0 10px rgba(255,87,34,0.5); }
      to { box-shadow: 0 0 20px rgba(255,87,34,0.8); }
    }

    .subtitle {
      font-size: 0.85rem;
      color: #666;
      font-style: italic;
      margin-top: 6px;
      opacity: 0.8;
    }

    .timestamp {
      font-size: 0.75rem;
      color: #888;
      margin-top: 10px;
      text-align: right;
      opacity: 0.7;
    }

    /* Input Area */
    #input-area {
      display: flex;
      padding: 20px;
      background: white;
      border-top: 2px solid #e0e0e0;
      gap: 12px;
    }

    #user-input {
      flex: 1;
      padding: 15px 20px;
      border: 2px solid #e0e0e0;
      border-radius: 30px;
      font-size: 1rem;
      outline: none;
      transition: all 0.3s ease;
    }

    #user-input:focus {
      border-color: #006064;
      box-shadow: 0 0 15px rgba(0,96,100,0.3);
    }

    #send-btn {
      padding: 15px 25px;
      border: none;
      border-radius: 30px;
      background: #006064;
      color: white;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

        #send-btn:hover {
            background: #004d40;
            transform: translateY(-1px);
        }

    /* Loading indicator */
    .loading::after {
      content: '';
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #006064;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .desktop-layout {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .controls-panel {
        order: 2;
      }
      
      .map-section {
        order: 1;
        padding: 15px;
      }
      
      .chat-container {
        order: 3; /* Chat comes after map on mobile */
      }
      
      #small-map {
        height: 250px;
      }
      
      #photo-upload {
        grid-template-columns: repeat(5, 1fr);
        gap: 10px;
      }
      
      .photo-slot {
        width: 60px;
        height: 60px;
        font-size: 18px;
      }
      
      .photo-slot.filled {
        font-size: 20px;
      }
      
      #disaster-options {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        padding: 15px;
      }
      
      .option-btn {
        padding: 10px 12px;
        font-size: 0.9rem;
      }
      
      header h1 {
        font-size: 1.5rem;
      }
      
      .main-content {
        padding: 10px;
        gap: 10px;
      }
    }

    @media (max-width: 480px) {
      #photo-upload {
        grid-template-columns: repeat(4, 1fr);
      }
      
      .photo-slot {
        width: 50px;
        height: 50px;
        font-size: 16px;
      }
    }
</style>
</head>
<body>
  <header>
    <h1>🌊 JalRakshak - Your Safety First</h1>
  </header>

  <div class="main-content">
    <!-- 1. PRIORITY: Accessibility Controls -->
    <div class="accessibility-section">
      <div>
        <label for="lang-select" style="color: #006064; font-weight: 600; margin-right: 8px;">🌐 Language:</label>
        <select id="lang-select">
          <option value="en">English</option>
          <option value="hi">हिन्दी</option>
          <option value="ta">தமிழ்</option>
          <option value="bn">বাংলা</option>
          <option value="te">తెలుగు</option>
        </select>
      </div>
      <button id="clear-chat-btn">🗑️ Clear Chat</button>
    </div>

    <div class="desktop-layout">
      <!-- Chat Container (Now on Left - Order 1) -->
      <div class="chat-container">
        <div id="messages"></div>
        
        <!-- INPUT AREA - CLEARLY VISIBLE -->
        <div id="input-area">
          <input id="user-input" type="text" placeholder="Type your message here...">
          <button id="send-btn">Send</button>
        </div>
      </div>

      <!-- Map Section (Now on Right - Order 2) -->
      <div class="map-section">
        <div class="map-header">
          <span>📍 Your Current Location</span>
          <span id="location-status" style="color: #4caf50; font-size: 0.9rem;">● Online</span>
        </div>
        <div id="small-map"></div>
        <div class="location-display">
          <div class="location-text">
            <strong>📍 Your Location:</strong>
          </div>
          <div class="coordinates-text" id="coordinates-text">
            <span class="loading">Detecting coordinates...</span>
          </div>
          <div class="address-text" id="address-text">
            <span class="loading">Getting address...</span>
          </div>
          <div class="location-timestamp" id="location-timestamp"></div>
        </div>
      </div>
    </div>

    <!-- Quick Disaster Options -->
    <div id="disaster-options"></div>

    <!-- Photo Upload -->
    <div class="photo-section">
      <div class="photo-title">📸 Upload Emergency Photos</div>
      <div id="photo-upload"></div>
    </div>

    <!-- Emergency Button -->
    <button id="emergency-btn">🚨 Emergency! Send Location</button>
  </div>

  <script>
    const GEMINI_API_KEY = "AIzaSyDQMUtyJ9sxYX6LuYQvSVpg8pOQZDrlL90";

    // Greetings
    const greetings = {
      en: "🙏 Namaste, I am JalRakshak. Please stay calm. Upload photos 📸 and report floods, tsunamis, or high waves immediately. How can I help you today?",
      hi: "🙏 नमस्ते, मैं जलरक्षक हूँ। कृपया शांत रहें। यदि आप बाढ़, सुनामी या ऊँची लहरें देखें, तो तुरंत रिपोर्ट करें। 📸 फोटो अपलोड करें। मैं आपकी कैसे मदद कर सकता हूँ?",
      ta: "🙏 வணக்கம், நான் ஜலரக்ஷக். தயவுசெய்து அமைதியாக இருங்கள். வெள்ளம், சுனாமி, உயர்ந்த அலைகள் இருந்தால் உடனடியாக தெரிவிக்கவும். 📸 புகைப்படங்களை பதிவேற்றவும்.",
      bn: "🙏 নমস্কার, আমি জলরক্ষক। দয়া করে শান্ত থাকুন। বন্যা, সুনামি বা উঁচু ঢেউ দেখলে অবিলম্বে রিপোর্ট করুন। 📸 ছবি আপলোড করুন। আমি কীভাবে সাহায্য করতে পারি?",
      te: "🙏 నమస్తే, నేను జలరక్షక్। దయచేసి శాంతంగా ఉండండి। మీరు వరదలు, సునామీలు లేదా ఎత్తైన అలలు గమనిస్తే వెంటనే నివేదించండి। 📸 ఫోటోలు అప్‌లోడ్ చేయండి।"
    };

    // Disaster options
    const disasterLabels = {
      en: ["🌊 Flood", "🌊 Tsunami", "🌀 Cyclone", "〰️ High Waves", "🏗️ Dam Break", "🌧️ Heavy Rain"],
      hi: ["🌊 बाढ़", "🌊 सुनामी", "🌀 चक्रवात", "〰️ ऊँची लहरें", "🏗️ बांध टूटना", "🌧️ भारी बारिश"],
      ta: ["🌊 வெள்ளம்", "🌊 சுனாமி", "🌀 சுழல்காற்று", "〰️ உயர் அலைகள்", "🏗️ அணை உடைதல்", "🌧️ தீவிர மழை"],
      bn: ["🌊 বন্যা", "🌊 সুনামি", "🌀 ঘূর্ণিঝড়", "〰️ উঁচু ঢেউ", "🏗️ বাঁধ ভেঙে যাওয়া", "🌧️ ভারী বৃষ্টি"],
      te: ["🌊 వరద", "🌊 సునామి", "🌀 తుఫాను", "〰️ ఎత్తైన అలలు", "🏗️ అణకట్ట విరగడం", "🌧️ భారీ వర్షం"]
    };

    // Emergency button labels
    const emergencyLabels = {
      en: "🚨 Emergency! Send Location",
      hi: "🚨 आपातकाल! लोकेशन भेजें",
      ta: "🚨 அவசரம்! இடத்தை அனுப்பவும்",
      bn: "🚨 জরুরি! অবস্থান পাঠান",
      te: "🚨 అత్యవసరము! లొకేషన్ పంపండి"
    };

    // Emergency responses
    const emergencyResponses = {
      en: "🚨 **EMERGENCY ALERT RECEIVED!**\n\nYour location has been sent to our emergency response center. Our rescue teams are being dispatched immediately.\n\n✅ **Status**: Location confirmed\n🚁 **Response**: Teams mobilized\n⏱️ **ETA**: Help is on the way\n\n**We hope to help you very soon! Stay safe!** 💙",
      hi: "🚨 **आपातकालीन अलर्ट प्राप्त!**\n\nआपका स्थान हमारे आपातकालीन केंद्र को भेजा गया है। हमारी बचाव टीमें तुरंत भेजी जा रही हैं।\n\n✅ **स्थिति**: स्थान पुष्ट\n🚁 **प्रतिक्रिया**: टीमें तैनात\n⏱️ **ETA**: सहायता आ रही है\n\n**हम जल्द आपकी मदद करने की उम्मीद करते हैं! सुरक्षित रहें!** 💙",
      ta: "🚨 **அவசரகால எச்சரிக்கை பெறப்பட்டது!**\n\nउங்கள் இடம் எங்கள் அவசரகால மையத்திற்கு அனுப்பப்பட்டுள்ளது। எங்கள் மீட்பு குழுக்கள் உடனடியாக அனுப்பப்படுகின்றன।\n\n✅ **நிலை**: இடம் உறுதி\n🚁 **பதில்**: குழுக்கள் அனுப்பப்பட்டன\n⏱️ **ETA**: உதவி வருகிறது\n\n**நாங்கள் விரைவில் உங்களுக்கு உதவ நம்புகிறோம்! பாதுகாப்பாக இருங்கள்!** 💙",
      bn: "🚨 **জরুরি সতর্কতা প্রাপ্ত!**\n\nআপনার অবস্থান আমাদের জরুরি কেন্দ্রে পাঠানো হয়েছে। আমাদের উদ্ধার দল অবিলম্বে পাঠানো হচ্ছে।\n\n✅ **অবস্থা**: অবস্থান নিশ্চিত\n🚁 **সাড়া**: দল মোতায়েন\n⏱️ **ETA**: সাহায্য আসছে\n\n**আমরা শীঘ্রই আপনাকে সাহায্য করার আশা করি! নিরাপদ থাকুন!** 💙",
      te: "🚨 **అత్యవసర హెచ్చరిక అందింది!**\n\nమీ లొకేషన్ మా అత్యవసర కేంద్రానికి పంపబడింది। మా రెస్క్యూ టీమ్‌లు వెంటనే పంపబడుతున్నాయి।\n\n✅ **స్థితి**: లొకేషన్ ధృవీకరించబడింది\n🚁 **ప్రతిస్పందన**: టీమ్‌లు మోహరించారు\n⏱️ **ETA**: సహాయం వస్తోంది\n\n**మేము త్వరలో మీకు సహాయం చేయాలని ఆశిస్తున్నాము! సురక్షితంగా ఉండండి!** 💙"
    };

    let currentLang = "en";
    let userLocation = null;
    let map = null;
    let userMarker = null;
    let chatHistory = [];
    let uploadedPhotos = [];

    const messagesDiv = document.getElementById("messages");
    const disasterDiv = document.getElementById("disaster-options");
    const emergencyBtn = document.getElementById("emergency-btn");

    // Reverse geocoding to get address from coordinates
    async function getAddressFromCoords(lat, lng) {
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=16`);
        const data = await response.json();
        
        if (data && data.display_name) {
          return data.display_name;
        } else {
          return "Address not found";
        }
      } catch (error) {
        console.error("Error getting address:", error);
        return "Unable to get address";
      }
    }

    // Initialize small map
    function initMap() {
      map = L.map('small-map').setView([20.5937, 78.9629], 5);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap'
      }).addTo(map);

      // Get user location
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          async (position) => {
            const { latitude, longitude } = position.coords;
            userLocation = { lat: latitude, lng: longitude };
            
            map.setView([latitude, longitude], 13);
            
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.marker([latitude, longitude])
              .addTo(map)
              .bindPopup("📍 You are here");

            await updateLocationDisplay(latitude, longitude);
          },
          (error) => {
            document.getElementById('coordinates-text').innerHTML = '❌ Location access denied';
            document.getElementById('address-text').innerHTML = 'Please enable location services for emergency features';
            document.getElementById('location-timestamp').innerHTML = 'Location unavailable';
            document.getElementById('location-status').style.color = '#f44336';
            document.getElementById('location-status').innerHTML = '● Offline';
          }
        );
      } else {
        document.getElementById('coordinates-text').innerHTML = '❌ Geolocation not supported';
        document.getElementById('address-text').innerHTML = 'Your browser does not support location services';
        document.getElementById('location-status').style.color = '#f44336';
        document.getElementById('location-status').innerHTML = '● Unsupported';
      }
    }

    // Update location display with exact coordinates and address
    async function updateLocationDisplay(lat, lng) {
      // Update coordinates
      document.getElementById('coordinates-text').innerHTML = 
        `Latitude: ${lat.toFixed(6)}, Longitude: ${lng.toFixed(6)}`;
      
      // Update timestamp
      document.getElementById('location-timestamp').innerHTML = 
        'Last updated: ' + new Date().toLocaleString();
      
      // Get and update address
      document.getElementById('address-text').innerHTML = 
        '<span class="loading">Getting address...</span>';
      
      const address = await getAddressFromCoords(lat, lng);
      document.getElementById('address-text').innerHTML = 
        `🏠 Address: ${address}`;
    }

    // Format timestamp
    function formatTime(date) {
      return date.toLocaleTimeString();
    }

    // Add message
    function addMessage(text, sender, subtitle = null, isEmergency = false) {
      const msg = document.createElement("div");
      msg.classList.add("message", sender);
      
      if (isEmergency) {
        msg.classList.add("emergency-location");
      }

      const mainText = document.createElement("div");
      mainText.innerHTML = text;
      msg.appendChild(mainText);

      if (subtitle) {
        const subText = document.createElement("div");
        subText.className = "subtitle";
        subText.innerText = subtitle;
        msg.appendChild(subText);
      }

      const timeText = document.createElement("div");
      timeText.className = "timestamp";
      timeText.innerText = formatTime(new Date());
      msg.appendChild(timeText);

      messagesDiv.appendChild(msg);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      chatHistory.push({ html: msg.outerHTML, timestamp: Date.now() });
    }

    // Send message
    async function sendMessage(userText, isEmergencyLocation = false) {
      addMessage(userText, "user", null, isEmergencyLocation);

      // Handle emergency location specially
      if (isEmergencyLocation) {
        setTimeout(() => {
          addMessage(emergencyResponses[currentLang], "bot");
        }, 1000);
        return;
      }

      // Show typing
      const typingMsg = document.createElement("div");
      typingMsg.classList.add("message", "bot");
      typingMsg.innerHTML = '<span class="loading">JalRakshak is typing...</span>';
      messagesDiv.appendChild(typingMsg);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      try {
        const response = await fetch(
          "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=" + GEMINI_API_KEY,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [{ parts: [{ text: userText }] }],
              system_instruction: {
                parts: [{
                  text: `You are JalRakshak, a disaster management assistant for ocean hazards.
Always reassure the user, tell them to stay calm, guide them with safety instructions,
and ask them to upload photos/videos so the emergency team can respond immediately.
Respond ONLY in ${currentLang} language.`
                }]
              }
            })
          }
        );

        messagesDiv.removeChild(typingMsg);

        const data = await response.json();
        const botText = data?.candidates?.[0]?.content?.parts?.[0]?.text || 
          "⚠️ Error: Please try again or call emergency services at 112.";
        
        addMessage(botText, "bot");

      } catch (error) {
        if (messagesDiv.contains(typingMsg)) {
          messagesDiv.removeChild(typingMsg);
        }
        addMessage("⚠️ Connection error. For emergency assistance call 112.", "bot");
      }
    }

    // Render disaster buttons
    function renderDisasterButtons() {
      disasterDiv.innerHTML = "";
      disasterLabels[currentLang].forEach(label => {
        const btn = document.createElement("button");
        btn.className = "option-btn";
        btn.innerHTML = label;
        btn.onclick = () => sendMessage("⚠️ " + label + " - I need help!");
        disasterDiv.appendChild(btn);
      });
    }

    // Update emergency button
    function renderEmergencyButton() {
      emergencyBtn.innerHTML = emergencyLabels[currentLang];
    }

    // Create photo upload slots
    function createPhotoUploadSlots() {
      const photoUpload = document.getElementById("photo-upload");
      photoUpload.innerHTML = ""; // Clear existing slots
      
      for (let i = 0; i < 10; i++) {
        const label = document.createElement("label");
        label.className = "photo-slot";
        label.innerHTML = '<input type="file" accept="image/*">📷';
        
        const input = label.querySelector("input");
        
        label.onclick = () => input.click();
        
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (file) {
            if (file.size > 10 * 1024 * 1024) {
              alert('File too large! Please select image under 10MB.');
              return;
            }
            
            label.classList.add('filled');
            label.innerHTML = '✓';
            uploadedPhotos.push(file);
            
            addMessage("📸 Emergency photo uploaded successfully! Our response team is analyzing the image.", "bot");
          }
        };
        
        photoUpload.appendChild(label);
      }
    }

    // Clear all chat and reset everything
    function clearChat() {
      if (confirm("⚠️ Clear all chat history and uploaded photos?")) {
        // Clear chat history
        chatHistory = [];
        messagesDiv.innerHTML = "";
        
        // Clear uploaded photos
        uploadedPhotos = [];
        
        // Recreate photo upload slots
        createPhotoUploadSlots();
        
        // Add welcome message
        addMessage(greetings[currentLang], "bot");
        
        console.log('Chat cleared successfully');
      }
    }

    // Emergency button click
    emergencyBtn.onclick = () => {
      if (navigator.geolocation) {
        emergencyBtn.innerHTML = '<span class="loading">Sending location...</span>';
        
        navigator.geolocation.getCurrentPosition(
          async (pos) => {
            const { latitude, longitude } = pos.coords;
            const address = await getAddressFromCoords(latitude, longitude);
            
            const locationText = `🚨 EMERGENCY LOCATION 🚨\n\n📍 Coordinates: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}\n🏠 Address: ${address}\n🗺️ Maps: https://maps.google.com/?q=${latitude},${longitude}\n⏰ Time: ${new Date().toLocaleString()}\n\n🆘 IMMEDIATE ASSISTANCE REQUIRED!`;
            
            sendMessage(locationText, true);
            
            // Update map
            if (map) {
              map.setView([latitude, longitude], 15);
              if (userMarker) map.removeLayer(userMarker);
              userMarker = L.marker([latitude, longitude])
                .addTo(map)
                .bindPopup("🚨 Emergency!")
                .openPopup();
            }

            await updateLocationDisplay(latitude, longitude);
            renderEmergencyButton();
          },
          error => {
            sendMessage("⚠️ Cannot get location. Please call 112 immediately!");
            renderEmergencyButton();
          }
        );
      }
    };

    // Language change
    document.getElementById("lang-select").onchange = (e) => {
      currentLang = e.target.value;
      messagesDiv.innerHTML = "";
      chatHistory = [];
      renderDisasterButtons();
      renderEmergencyButton();
      addMessage(greetings[currentLang], "bot");
    };

    // Send button functionality
    document.getElementById("send-btn").onclick = () => {
      const input = document.getElementById("user-input");
      if (input.value.trim()) {
        sendMessage(input.value.trim());
        input.value = "";
      }
    };

    // Enter key to send
    document.getElementById("user-input").addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById("send-btn").click();
      }
    });

    // Clear chat button
    document.getElementById("clear-chat-btn").onclick = clearChat;

    // Initialize everything
    window.onload = function() {
      initMap();
      renderDisasterButtons();
      renderEmergencyButton();
      createPhotoUploadSlots();
      addMessage(greetings[currentLang], "bot");

      // Update location periodically
      setInterval(() => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            async (position) => {
              const { latitude, longitude } = position.coords;
              if (userLocation && 
                  (Math.abs(userLocation.lat - latitude) > 0.001 || 
                   Math.abs(userLocation.lng - longitude) > 0.001)) {
                userLocation = { lat: latitude, lng: longitude };
                await updateLocationDisplay(latitude, longitude);
                
                if (map && userMarker) {
                  userMarker.setLatLng([latitude, longitude]);
                }
              }
            }
          );
        }
      }, 300000); // Update every 5 minutes
    };

    console.log('🌊 JalRakshak Chat System Ready!');
  </script>
</body>
</html>
